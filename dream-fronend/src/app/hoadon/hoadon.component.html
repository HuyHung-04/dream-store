<div class="hoa-don">
  <h2 style="color: #294764; font-weight: bold; font-size: 18px;">
    Quản lý hóa đơn
  </h2>
  <!-- Phần tìm kiếm -->
  <div class="tim-kiem">
    <p style="color: #294764;font-weight: bold; font-size: 14px;">Tìm kiếm</p>
    <div class="input-row">
      <div class="bor">
        <div class="input-field">
          <label class="label-date">Ngày tạo</label>
          <div class="form-date" style="width: 250px;">
            <input type="date" class="input" id="fromDate">
            <input type="date" class="input" id="toDate">
          </div>
        </div>
      </div>
        <div class="input-field">
          <label class="label-date">Ngày sửa</label>
          <div class="form-date" style="width: 250px;">
            <input type="date" class="input" id="fromDate">
            <input type="date" class="input" id="toDate">
          </div>
        </div>
      <div class="input-field">
        <label for="maHoaDon">Số điện thoại khách hàng</label>
        <input type="text" id="maHoaDon" class="input" placeholder="Nhập số điện thoại..." style="width: 250px;">
      </div>
      <div class="input-field">
        <label for="trangThai">Trạng thái</label>
        <select class="input" id="trangThai" name="trangThai" style="width: 250px;">
          <option value="" disabled selected>Tất cả trạng thái</option>
          <option value="1">Chờ xác nhận</option>
          <option value="2">Đã xác nhận</option>
          <option value="3">Đang giao hàng</option>
          <option value="4">Đã giao hàng</option>
          <option value="5">Đã huỷ</option>
          <option value="6">Chưa thanh toán</option>
          <option value="7">Đã thanh toán</option>
        </select>
      </div>
    </div>
    <div class="input-row">
      <div class="input-field">
        <label for="maHoaDon">Mã hóa đơn</label>
        <input style="width: 250px;" type="text" id="maHoaDon" class="input" placeholder="Nhập mã hóa đơn..." [(ngModel)]="searchRequest.maHoaDon">
      </div>
      <div class="input-field">
        <label for="tenKhachHang">Tên khách hàng</label>
        <input style="width: 250px;" type="text" id="tenKhachHang" class="input" placeholder="Nhập tên khách hàng..." [(ngModel)]="searchRequest.tenKhachHang">
      </div>
      <div class="input-field">
        <label for="tenNhanVien">Tên nhân viên</label>
        <input style="width: 250px;" type="text" id="tenNhanVien" class="input" placeholder="Nhập tên nhân viên..." [(ngModel)]="searchRequest.tenNhanVien">
      </div>
      <div class="input-field">
        <label for="">Loại hoá đơn</label>
        <select class="input" id="" name="" style="width: 250px;">
          <option value="" disabled selected>Tất cả hoá đơn</option>
          <option value="1">Hoá đơn offline</option>
          <option value="0">Hoá đơn online</option>
        </select>
      </div>
    </div>    
  </div>
  <!-- Bảng hiển thị hóa đơn -->
  <div class="table-don-off">
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Mã hóa đơn</th>
          <th>Tên khách hàng</th>
          <th>Số điện thoại khách hàng</th>
          <th>Tên nhân viên</th>
          <th>Phương thức thanh toán</th>
          <th>Tiền trước voucher</th>
          <th>Tổng tiền thanh toán</th>
          <th>Ngày tạo</th>
          <th>Trạng thái</th>
          <th>Xem chi tiết</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let invoice of hoaDons.content; trackBy: trackById">
          <td>{{ invoice.maHoaDon }}</td>
          <td>{{ invoice.tenKhachHang }}</td>
          <td>{{ invoice.sdtNguoiNhan }}</td>
          <td>{{ invoice.tenNhanVien }}</td>
          <td>{{ invoice.tenPhuongThucThanhToan }}</td>
          <td>{{ invoice.tongTienTruocVoucher | number:'1.0-0' }} VNĐ</td>
          <!-- <td>
              <span *ngIf="invoice.tenVoucher; else noVoucher">
                {{ invoice.tenVoucher }} (Giảm {{ invoice.giaTriGiam }}{{ invoice.hinhThucGiam ? ' %' : ' VNĐ' }})
              </span>
            <ng-template #noVoucher>Không</ng-template>
          </td> -->
          <td>{{ invoice.tongTienThanhToan | number:'1.0-0' }} VNĐ</td>
          <td>{{ invoice.ngayTao | date:'yyyy-MM-dd' }}</td>
          <td>
            <!-- Hiển thị nút trạng thái nếu trong danh sách có thể đổi -->
            <button
              *ngIf="isTrangThaiCoTheChuyen(invoice.trangThai)"
              (click)="doiTrangThai(invoice)"
              class="btn-doi-trang-thai"
            >
              {{ getTrangThaiText(invoice.trangThai) }}
            </button>
          
            <!-- Nếu không đổi được, chỉ hiển thị text -->
            <span *ngIf="!isTrangThaiCoTheChuyen(invoice.trangThai)">
              {{ getTrangThaiText(invoice.trangThai) }}
            </span>
          </td>
          
          <td>
            <button class="xem-chi-tiet" (click)="selectHoaDonChiTiet(invoice)">
              <i class="bi bi-eye-fill"></i>
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <!-- Phân trang -->
    <div class="pagination">
      <button (click)="prevPage()" [disabled]="searchRequest.page <= 1">
        <i class="bi bi-chevron-double-left"></i>
      </button>
      <span>{{ searchRequest.page }} / {{ hoaDons.totalPages }}</span>
      <button (click)="nextPage()" [disabled]="searchRequest.page >= hoaDons.totalPages">
        <i class="bi bi-chevron-double-right"></i>
      </button>
    </div>    

  <!-- Popup modal hiển thị chi tiết hóa đơn -->
  <div class="modal" *ngIf="showDetailPopup">
    <div class="modal-content">
      <span class="close" (click)="closePopup()">&times;</span>
      <h3>Chi tiết hóa đơn</h3>
      <div *ngIf="selectedInvoiceDetail; else loading">
        <p><strong>Mã hóa đơn:</strong> {{ selectedInvoiceDetail.maHoaDon }}</p>
        <p><strong>Tên khách hàng:</strong> {{ selectedInvoiceDetail.tenKhachHang }}</p>
        <p><strong>Tên nhân viên:</strong> {{ selectedInvoiceDetail.tenNhanVien }}</p>
        <p><strong>Voucher:</strong> {{ selectedInvoiceDetail.tenVoucher }} (Giảm {{ selectedInvoiceDetail.giaTriGiam }}{{ selectedInvoiceDetail.hinhThucGiam ? ' %' : ' VNĐ' }})</p>
        <p><strong>Tiền trước voucher:</strong> {{ selectedInvoiceDetail.tongTienTruocVoucher | number:'1.0-0' }} VNĐ</p>
        <p><strong>Tổng tiền:</strong> {{ selectedInvoiceDetail.tongTienThanhToan | number:'1.0-0' }} VNĐ</p>
        <p><strong>Ghi chú:</strong> {{ selectedInvoiceDetail.ghiChu }}</p>
        <p><strong>Ngày tạo:</strong> {{ selectedInvoiceDetail.ngayTao | date:'yyyy-MM-dd' }}</p>
        <!-- Bạn có thể hiển thị các trường khác theo yêu cầu -->
      </div>
      <ng-template #loading>
        <p>Đang tải dữ liệu...</p>
      </ng-template>
    </div>
  </div>
</div>

<!-- Modal chi tiết (trống) -->
<div class="modal" *ngIf="showDetailPopup">
  <div class="modal-content">
    <!-- Nội dung trống -->
    <div class="modal-body">
      <div *ngIf="hoaDonData" class="invoice-container">
        <!-- Mã hóa đơn (Căn phải) -->
        <div class="invoice-header">
          <h3>Chi tiết Hóa Đơn</h3>
          <p class="invoice-code"><strong>Mã hóa đơn:</strong> {{ hoaDonData.ma }}</p>
        </div>
      
      
        <!-- Địa chỉ nhận hàng -->
        <section class="section">
          <h3>Địa chỉ nhận hàng</h3>
          <p><strong>Tên người nhận:</strong> {{ hoaDonData.tenNguoiNhan }}</p>
          <p><strong>Số điện thoại:</strong> {{ hoaDonData.sdtNguoiNhan }}</p>
          <p><strong>Địa chỉ:</strong> {{ hoaDonData.diaChiNhanHang }}</p>
        </section>
      
        <!-- Chi tiết hóa đơn -->
        <section class="section">
      
          <div *ngFor="let item of chiTietHoaDonData" class="invoice-details-item">
            <img [src]="'http://localhost:8080' + item.anhUrls" alt="{{ item.tenSanPham }}" />
            <div class="invoice-details-info">
              <p><strong>Tên Sản Phẩm:</strong> {{ item.tenSanPham }}</p>
              <p><strong>Đơn Giá:</strong> {{ item.donGia | number }}</p>
              <p><strong>Số Lượng:</strong> {{ item.soLuong }}</p>
              <p><strong>Thành Tiền:</strong> {{ item.donGia * item.soLuong | number }} VNĐ</p>
              <p><strong>Màu Sắc:</strong> {{ item.mauSac }}</p>
            </div>
          </div>
        </section>
      
        <!-- Chi tiết thanh toán -->
        <section class="section">
          <h3>Chi tiết thanh toán</h3>
          <p><strong>Tổng tiền trước voucher:</strong> {{ hoaDonData.tongTienTruocVoucher | number }} VNĐ</p>
          <!-- Điều kiện hiển thị voucher và giá trị giảm -->
          <div *ngIf="hoaDonData.voucher">
            <p><strong>Tên voucher:</strong> {{ hoaDonData.voucher?.ten }}</p>
      
            <!-- Hiển thị giá trị giảm nếu voucher giảm phần trăm -->
            <p *ngIf="hoaDonData.voucher?.hinhThucGiam === false"><strong>Giảm giá:</strong> {{ hoaDonData.voucher?.giaTriGiam
              + '%' }}</p>
      
            <!-- Hiển thị giá trị giảm nếu voucher giảm tiền -->
            <p *ngIf="hoaDonData.voucher?.hinhThucGiam === true"><strong>Giảm giá:</strong> {{ hoaDonData.voucher?.giaTriGiam
              + ' VNĐ' }}</p>
      
            <!-- Ẩn "Giảm tối đa" nếu giảm tiền -->
            <p *ngIf="hoaDonData.voucher?.hinhThucGiam === false"><strong>Giảm tối đa:</strong> {{
              hoaDonData.voucher?.giamToiDa }} VNĐ</p>
          </div>
      
          <!-- Nếu không có voucher thì không hiển thị thông tin voucher -->
          <p *ngIf="!hoaDonData.voucher"><strong>Hóa đơn không áp dụng voucher</strong></p>
          <p><strong>Tên phương thức:</strong> {{ hoaDonData.phuongThucThanhToan?.ten }}</p>
          <p><strong>Phí vận chuyển:</strong> {{ hoaDonData.phiVanChuyen | number }} VNĐ</p>
          <p><strong>Tổng tiền thanh toán:</strong> {{ hoaDonData.tongTienThanhToan | number }} VNĐ</p>
        </section>
      
        <!-- Nút Hủy và Nút Quay Về Trang Chủ -->
        <div class="button-container">
          <button (click)="goHome()" class="btn btn-primary">Đóng</button>
        </div>
      
      </div>
      
    </div>
  </div>
</div>

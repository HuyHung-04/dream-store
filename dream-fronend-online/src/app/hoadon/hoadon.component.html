<!-- Hi·ªÉn th·ªã ƒë·ªãa ch·ªâ ƒë√£ ch·ªçn -->
<div *ngIf="diaChiList.length > 0; else noAddresses" class="address-list">
  <div class="address-item-select" (click)="openModal()">
    <div class="address-container">
      <p class="map"><i class="bi bi-geo-alt-fill"> ƒê·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n</i></p>
      <div class="customer-info">
        <p class="customer-name">T√™n ng∆∞·ªùi nh·∫≠n: {{ selectedAddress?.tenNguoiNhan }}</p>
        <p class="customer-phone"> (+84 | {{ selectedAddress?.sdtNguoiNhan }} ) </p>
      </div>
      <p class="address-text">
        ƒê·ªãa ch·ªâ: {{ selectedAddress?.diaChiCuThe }}, {{ selectedAddress?.phuongXa }}, {{ selectedAddress?.quanHuyen }},
        {{ selectedAddress?.tinhThanhPho }}
      </p>
    </div>
  </div>
</div>

<!-- N·∫øu ch∆∞a c√≥ ƒë·ªãa ch·ªâ -->
<ng-template #noAddresses>
  <p class="no-address">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o ƒë∆∞·ª£c th√™m.</p>
</ng-template>

<!-- Modal -->
<div *ngIf="isModalOpen" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <button [class.active]="activeTab === 'select'" (click)="activeTab='select'">Ch·ªçn ƒê·ªãa Ch·ªâ</button>
      <button [class.active]="activeTab === 'add'" (click)="activeTab='add'">Th√™m ƒê·ªãa Ch·ªâ M·ªõi</button>
    </div>

    <div class="modal-body">
      <!-- Tab Ch·ªçn ƒê·ªãa Ch·ªâ -->
      <div *ngIf="activeTab === 'select'">
        <ul>
          <li *ngFor="let diaChi of diaChiList; let i = index" class="address-item"
            [class.selected]="selectedIndex === i" (click)="selectAddress(i)">
            <div class="address-container">
              <div class="customer-info">
                <p class="customer-name">T√™n ng∆∞·ªùi nh·∫≠n: {{ diaChi.tenNguoiNhan}}</p>
                <p class="customer-phone">(+84 | {{diaChi.sdtNguoiNhan}})</p>
              </div>
              <p>ƒê·ªãa ch·ªâ: {{ diaChi.diaChiCuThe }}, {{ diaChi.phuongXa }}, {{ diaChi.quanHuyen }}, {{
                diaChi.tinhThanhPho }}</p>
              <div class="btn-container">
                <button class="btn-edit" (click)="editDiaChi(diaChi.id); $event.stopPropagation()"><i
                    class="bi bi-pencil-square"></i> S·ª≠a</button>
                <button class="btn-delete" (click)="deleteDiaChi(diaChi.id,i); $event.stopPropagation()"><i
                    class="bi bi-trash"></i> X√≥a</button>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <!-- Tab Th√™m ƒê·ªãa Ch·ªâ M·ªõi -->
      <div *ngIf="activeTab === 'add'" class="add-address-form">
        <input [(ngModel)]="newAddress.tenNguoiNhan" placeholder="T√™n ng∆∞·ªùi nh·∫≠n" class="form-control">
        <input [(ngModel)]="newAddress.sdtNguoiNhan" placeholder="S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n" class="form-control">
        <select [(ngModel)]="newAddress.tinhThanhPho" (change)="onSelectTinhThanh($event)" class="form-control">
          <option value="" disabled [selected]="!AddressEdit.tinhThanhPho">Ch·ªçn T·ªânh/Th√†nh Ph·ªë</option>
          <option *ngFor="let tinh of tinhThanhPhoList" [value]="tinh.ProvinceID">{{ tinh.ProvinceName }}</option>
        </select>
        <select [(ngModel)]="newAddress.quanHuyen" (change)="onSelectQuanHuyen($event)" class="form-control">
          <option *ngFor="let quan of quanHuyenList" [value]="quan.DistrictID">{{ quan.DistrictName }}</option>
          <option value="" disabled selected>Ch·ªçn Qu·∫≠n/Huy·ªán</option>
        </select>
        <select [(ngModel)]="newAddress.phuongXa" class="form-control">
          <option value="" disabled selected>Ch·ªçn Ph∆∞·ªùng/X√£</option> <!-- Placeholder -->
          <option *ngFor="let xa of phuongXaList" [value]="xa.WardCode">{{ xa.WardName }}</option>
        </select>
        <input [(ngModel)]="newAddress.diaChiCuThe" class="form-control" placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ">
        <button class="btn-save" (click)="addDiaChi()">L∆∞u ƒê·ªãa Ch·ªâ</button>
      </div>
    </div>

    <button class="close-btn" (click)="closeModal()">ƒê√≥ng</button>
  </div>
</div>

<!-- Modal Ch·ªânh s·ª≠a ƒê·ªãa Ch·ªâ -->
<div *ngIf="isEditModalOpen" class="edit-modal-overlay" (click)="$event.stopPropagation()">
  <div class="edit-modal">
    <div class="edit-modal-header">
      <h2>S·ª≠a ƒê·ªãa Ch·ªâ</h2>

    </div>

    <div class="edit-modal-body">
      <input [(ngModel)]="AddressEdit.tenNguoiNhan" placeholder="T√™n ng∆∞·ªùi nh·∫≠n" class="edit-input">
      <input [(ngModel)]="AddressEdit.sdtNguoiNhan" placeholder="S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n" class="edit-input">

      <!-- T·ªânh/Th√†nh ph·ªë -->
      <select [(ngModel)]="newAddress.tinhThanhPho" (change)="onSelectTinhThanh($event)" class="edit-input">
        <option value="" disabled selected>Ch·ªçn T·ªânh/Th√†nh Ph·ªë</option>
        <option *ngFor="let tinh of tinhThanhPhoList" [value]="tinh.ProvinceID">{{ tinh.ProvinceName }}</option>
      </select>

      <!-- Qu·∫≠n/Huy·ªán -->
      <select [(ngModel)]="newAddress.quanHuyen" (change)="onSelectQuanHuyen($event)" class="edit-input">
        <option value="" disabled selected>Ch·ªçn Qu·∫≠n/Huy·ªán</option>
        <option *ngFor="let quan of quanHuyenList" [value]="quan.DistrictID">{{ quan.DistrictName }}</option>
      </select>

      <!-- Ph∆∞·ªùng/X√£ -->
      <select [(ngModel)]="newAddress.phuongXa" class="edit-input">
        <option value="" disabled selected>Ch·ªçn Ph∆∞·ªùng/X√£</option>
        <option *ngFor="let xa of phuongXaList" [value]="xa.WardCode">{{ xa.WardName }}</option>
      </select>


      <input [(ngModel)]="AddressEdit.diaChiCuThe" class="edit-input" placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ">
      <button class="btn-save-edit" (click)="updateDiaChi()">L∆∞u ƒê·ªãa Ch·ªâ</button>
      <button class="btn-save-edit" (click)="closeEditModal()">ƒê√≥ng</button>
    </div>
  </div>
</div>


<div *ngIf="chiTietGioHang.length > 0; else noItems" class="gio-hang">
  <div *ngFor="let item of chiTietGioHang" class="gio-hang-item">
    <div class="item-image">
      <img [src]="'http://localhost:8080' + item.anhUrl" alt="{{ item.tenSanPham }}" />
    </div>

    <div class="item-details">
      <div class="item-header">
        <h3 class="item-title">{{ item.tenSanPham }}</h3>
        <p class="item-price">{{ item.donGia | currency }}</p>
      </div>

      <div class="item-info">
        <p><strong>M√†u s·∫Øc:</strong> {{ item.mau }}</p>
        <p><strong>Size:</strong> {{ item.size }}</p>
        <p><strong>S·ªë l∆∞·ª£ng:</strong> {{ item.soLuong }}</p>
      </div>
      <div *ngIf="item.khuyenMai" class="discount-info">
        <p><strong>Gi·∫£m gi√°:</strong> {{ item.giaTriGiam }} ({{ item.hinhThucGiam ? 'Gi·∫£m tr·ª±c ti·∫øp' : 'Gi·∫£m ph·∫ßn trƒÉm'
          }})</p>
        <p><strong>Gi√° sau gi·∫£m:</strong> {{ item.donGiaSauGiam | currency }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu gi·ªè h√†ng tr·ªëng -->
<ng-template #noItems>
  <p>Gi·ªè h√†ng c·ªßa b·∫°n hi·ªán t·∫°i tr·ªëng.</p>
</ng-template>


<!-- Ph·∫ßn thanh to√°n b√™n ph·∫£i -->
<div class="payment-summary">
  <div class="summary-header">
    <label for="">T·∫°m t√≠nh: {{ totalPrice }} VND</label>
  </div>

  <div class="summary-item">
    <label for="voucher">Voucher:</label>
    <select id="voucher" [(ngModel)]="selectedVoucher" (change)="updateTotalPrice()" class="selectoption">
      <option value="">Ch·ªçn voucher</option>
      <option *ngFor="let voucher of vouchers" [ngValue]="voucher">
        {{ voucher.ten}} VND
      </option>
    </select>
  </div>

  <!-- üí∞ Hi·ªÉn th·ªã "Gi·∫£m t·ªëi ƒëa" n·∫øu c√≥ voucher ƒë∆∞·ª£c ch·ªçn -->
  <div class="max-sale" *ngIf="selectedVoucherMaxDiscount">
    <label>Gi·∫£m t·ªëi ƒëa: {{ selectedVoucherMaxDiscount | number }} VND</label>
  </div>

  <div class="summary-item">
    <label>Ph√≠ v·∫≠n chuy·ªÉn: {{ shippingFee | number }} VND</label>
    <p></p>
  </div>

   <!-- Hi·ªÉn th·ªã ph∆∞∆°ng th·ª©c thanh to√°n -->
   <div class="payment">
    <label >Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
    <select id="payment-method" [(ngModel)]="selectedPaymentMethod" class="selectoption">
      <option value="" disabled>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</option>
      <option *ngFor="let method of paymentMethods" [value]="method.id">
        {{ method.ten }}
      </option>
    </select>
  </div>

  <div></div>
  <div class="summary-item">
    <label for="total">T·ªïng ti·ªÅn thanh to√°n: {{ totalPriceAfterDiscount }} VND</label>

  </div>

  <button class="btn-checkout" (click)="createHoaDon()">Thanh to√°n</button>
  
</div>



<!-- Modal Ch·ª©c NƒÉng Sau Thanh To√°n -->
<div *ngIf="modalthongbao" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content">
    <h3>Ch·ªçn h√†nh ƒë·ªông</h3>
    <button (click)="viewInvoiceDetails()">Xem Chi Ti·∫øt ƒê∆°n H√†ng</button>
    <button (click)="viewInvoiceHistory()">Xem L·ªãch S·ª≠ ƒê∆°n H√†ng</button>
    <button (click)="goHome()">Quay V·ªÅ Trang Ch·ªß</button>
  </div>
</div>